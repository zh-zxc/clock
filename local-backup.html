<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é’Ÿæ•°æ®æœ¬åœ°å¤‡ä»½å·¥å…·</title>
    <style>
        :root {
            --primary: #4cc9f0; --secondary: #f72585; --accent: #4361ee;
            --success: #00d084; --error: #ff4d4d; --warning: #ffb84d;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        h1 { color: var(--primary); text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; }
        .section h2 { color: var(--accent); margin-bottom: 15px; font-size: 1.2rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; flex: 1; min-width: 120px; font-size: 14px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--accent)); color: white; }
        .btn-success { background: linear-gradient(45deg, var(--success), #00a86b); color: white; }
        .btn-warning { background: linear-gradient(45deg, var(--warning), #ff9800); color: white; }
        .btn-danger { background: linear-gradient(45deg, var(--error), #cc0000); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .status {
            margin-top: 15px; padding: 12px; border-radius: 8px; font-size: 14px; display: none;
        }
        .status.success { background: rgba(0, 208, 132, 0.1); color: var(--success); border: 1px solid var(--success); }
        .status.error { background: rgba(255, 77, 77, 0.1); color: var(--error); border: 1px solid var(--error); }
        .status.info { background: rgba(76, 201, 240, 0.1); color: var(--primary); border: 1px solid var(--primary); }
        .file-input-wrapper {
            position: relative; overflow: hidden; display: inline-block; width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;
        }
        .file-input-label {
            display: block; padding: 12px; background: white; border: 2px dashed #ccc; border-radius: 8px;
            text-align: center; color: #666; cursor: pointer; transition: all 0.3s ease;
        }
        .file-input-label:hover { border-color: var(--primary); color: var(--primary); }
        .info-box {
            background: rgba(76, 201, 240, 0.1); border-left: 4px solid var(--primary);
            padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 14px; line-height: 1.6;
        }
        .info-box h3 { color: var(--primary); margin-bottom: 8px; font-size: 1rem; }
        .info-box ul { margin-left: 20px; }
        .info-box li { margin-bottom: 5px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .stat-item { background: white; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 12px; color: #666; }
        .stat-value { font-size: 18px; font-weight: bold; color: var(--primary); }
        @media (max-width: 480px) {
            .container { padding: 20px; }
            .btn-group { flex-direction: column; }
            button { width: 100%; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° æ—¶é’Ÿæ•°æ®å¤‡ä»½å·¥å…·</h1>
        <p class="subtitle">æœ¬åœ°æ•°æ®å¤‡ä»½ä¸æ¢å¤</p>

        <!-- æ•°æ®ç»Ÿè®¡ -->
        <div class="section">
            <h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">è®°äº‹æ•°é‡</div>
                    <div class="stat-value" id="note-count">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ¶ˆè´¹è®°å½•</div>
                    <div class="stat-value" id="expense-count">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ€»æ¶ˆè´¹</div>
                    <div class="stat-value" id="total-expense">Â¥0</div>
                </div>
            </div>
        </div>

        <!-- å¤‡ä»½åŠŸèƒ½ -->
        <div class="section">
            <h2>ğŸ’¾ å¤‡ä»½æ•°æ®</h2>
            <div class="btn-group">
                <button class="btn-primary" onclick="exportData()">å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶</button>
                <button class="btn-success" onclick="copyToClipboard()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
            <div id="export-status" class="status"></div>
        </div>

        <!-- æ¢å¤åŠŸèƒ½ -->
        <div class="section">
            <h2>ğŸ“‚ æ¢å¤æ•°æ®</h2>
            <div class="file-input-wrapper">
                <input type="file" id="file-input" accept=".json" onchange="importData(event)">
                <label for="file-input" class="file-input-label">
                    ğŸ“ ç‚¹å‡»é€‰æ‹©å¤‡ä»½æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„
                </label>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn-warning" onclick="pasteFromClipboard()">ä»å‰ªè´´æ¿ç²˜è´´</button>
                <button class="btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            </div>
            <div id="import-status" class="status"></div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="info-box">
            <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>å¯¼å‡ºæ•°æ®ï¼š</strong>å°†æ‰€æœ‰è®°äº‹å’Œæ¶ˆè´¹è®°å½•ä¿å­˜ä¸ºJSONæ–‡ä»¶</li>
                <li><strong>å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š</strong>å¿«é€Ÿå¤åˆ¶æ•°æ®ï¼Œæ–¹ä¾¿ç²˜è´´åˆ°å…¶ä»–åœ°æ–¹</li>
                <li><strong>æ¢å¤æ•°æ®ï¼š</strong>é€‰æ‹©å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</li>
                <li><strong>ä»å‰ªè´´æ¿æ¢å¤ï¼š</strong>ç²˜è´´ä¹‹å‰å¤åˆ¶çš„JSONæ•°æ®</li>
                <li><strong>æ¸…ç©ºæ•°æ®ï¼š</strong>åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆè°¨æ…æ“ä½œï¼‰</li>
            </ul>
            <p style="margin-top: 10px; color: #666;">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>å»ºè®®å®šæœŸå¤‡ä»½æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚
                æ‚¨å¯ä»¥å°†å¤‡ä»½æ–‡ä»¶ä¿å­˜åˆ°äº‘ç›˜ï¼ˆå¦‚ç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œäº‘ç›˜ç­‰ï¼‰ã€‚
            </p>
        </div>
    </div>

    <script>
        // é…ç½®
        const STORAGE_KEYS = {
            NOTES: 'clock_notes',
            EXPENSES: 'clock_expenses'
        };

        // å·¥å…·å‡½æ•°
        const Utils = {
            formatCurrency(amount) {
                return `Â¥${amount.toFixed(2)}`;
            },
            getCurrentTimestamp() {
                return new Date().toISOString();
            },
            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (err) {
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        return true;
                    } catch (e) {
                        document.body.removeChild(textarea);
                        return false;
                    }
                }
            },
            async readFromClipboard() {
                try {
                    return await navigator.clipboard.readText();
                } catch (err) {
                    return null;
                }
            }
        };

        // æ•°æ®ç®¡ç†å™¨
        class DataManager {
            static getData(key, defaultValue = {}) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error(`è¯»å–æ•°æ®å¤±è´¥: ${key}`, error);
                    return defaultValue;
                }
            }

            static setData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error(`ä¿å­˜æ•°æ®å¤±è´¥: ${key}`, error);
                    return false;
                }
            }

            static removeData(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error(`åˆ é™¤æ•°æ®å¤±è´¥: ${key}`, error);
                    return false;
                }
            }

            static getAllData() {
                return {
                    notes: this.getData(STORAGE_KEYS.NOTES, {}),
                    expenses: this.getData(STORAGE_KEYS.EXPENSES, {}),
                    version: '1.0',
                    exportTime: Utils.getCurrentTimestamp(),
                    source: 'æ—¶é’Ÿåº”ç”¨å¤‡ä»½'
                };
            }

            static importAllData(data) {
                try {
                    if (data.notes) {
                        this.setData(STORAGE_KEYS.NOTES, data.notes);
                    }
                    if (data.expenses) {
                        this.setData(STORAGE_KEYS.EXPENSES, data.expenses);
                    }
                    return true;
                } catch (error) {
                    console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }

            static clearAll() {
                try {
                    this.removeData(STORAGE_KEYS.NOTES);
                    this.removeData(STORAGE_KEYS.EXPENSES);
                    return true;
                } catch (error) {
                    console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }

            static getStats() {
                const notes = this.getData(STORAGE_KEYS.NOTES, {});
                const expenses = this.getData(STORAGE_KEYS.EXPENSES, {});
                
                let noteCount = 0;
                let expenseCount = 0;
                let totalExpense = 0;

                // ç»Ÿè®¡è®°äº‹
                Object.values(notes).forEach(noteList => {
                    noteCount += noteList.length;
                });

                // ç»Ÿè®¡æ¶ˆè´¹
                Object.values(expenses).forEach(expenseList => {
                    expenseCount += expenseList.length;
                    expenseList.forEach(expense => {
                        totalExpense += expense.amount || 0;
                    });
                });

                return { noteCount, expenseCount, totalExpense };
            }
        }

        // UIç®¡ç†å™¨
        class UIManager {
            static showStatus(elementId, message, type = 'info') {
                const element = document.getElementById(elementId);
                if (!element) return;

                element.textContent = message;
                element.className = `status ${type}`;
                element.style.display = 'block';

                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            }

            static hideStatus(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }

            static updateStats() {
                const stats = DataManager.getStats();
                
                const noteCountEl = document.getElementById('note-count');
                const expenseCountEl = document.getElementById('expense-count');
                const totalExpenseEl = document.getElementById('total-expense');

                if (noteCountEl) noteCountEl.textContent = stats.noteCount;
                if (expenseCountEl) expenseCountEl.textContent = stats.expenseCount;
                if (totalExpenseEl) totalExpenseEl.textContent = Utils.formatCurrency(stats.totalExpense);
            }
        }

        // å¯¼å‡ºåŠŸèƒ½
        function exportData() {
            try {
                const data = DataManager.getAllData();
                const json = JSON.stringify(data, null, 2);
                const filename = `æ—¶é’Ÿæ•°æ®å¤‡ä»½_${new Date().toLocaleDateString('zh-CN')}.json`;
                
                Utils.downloadFile(json, filename, 'application/json');
                
                UIManager.showStatus('export-status', 'âœ… æ•°æ®å·²å¯¼å‡ºåˆ°ä¸‹è½½æ–‡ä»¶å¤¹', 'success');
            } catch (error) {
                UIManager.showStatus('export-status', `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        async function copyToClipboard() {
            try {
                const data = DataManager.getAllData();
                const json = JSON.stringify(data, null, 2);
                
                const success = await Utils.copyToClipboard(json);
                
                if (success) {
                    UIManager.showStatus('export-status', 'âœ… æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    UIManager.showStatus('export-status', 'âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (error) {
                UIManager.showStatus('export-status', `âŒ å¤åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯¼å…¥æ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!data.notes || !data.expenses) {
                        throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                    }

                    const success = DataManager.importAllData(data);
                    
                    if (success) {
                        UIManager.showStatus('import-status', 'âœ… æ•°æ®æ¢å¤æˆåŠŸï¼', 'success');
                        UIManager.updateStats();
                    } else {
                        UIManager.showStatus('import-status', 'âŒ æ•°æ®æ¢å¤å¤±è´¥', 'error');
                    }
                } catch (error) {
                    UIManager.showStatus('import-status', `âŒ æ–‡ä»¶è§£æå¤±è´¥: ${error.message}`, 'error');
                }
            };
            reader.onerror = function() {
                UIManager.showStatus('import-status', 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            reader.readAsText(file);

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // ä»å‰ªè´´æ¿ç²˜è´´
        async function pasteFromClipboard() {
            try {
                const text = await Utils.readFromClipboard();
                
                if (!text) {
                    UIManager.showStatus('import-status', 'âŒ å‰ªè´´æ¿ä¸ºç©ºæˆ–æ— æƒé™è®¿é—®', 'error');
                    return;
                }

                const data = JSON.parse(text);
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (!data.notes || !data.expenses) {
                    throw new Error('å‰ªè´´æ¿æ•°æ®æ ¼å¼æ— æ•ˆ');
                }

                const success = DataManager.importAllData(data);
                
                if (success) {
                    UIManager.showStatus('import-status', 'âœ… æ•°æ®æ¢å¤æˆåŠŸï¼', 'success');
                    UIManager.updateStats();
                } else {
                    UIManager.showStatus('import-status', 'âŒ æ•°æ®æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                UIManager.showStatus('import-status', `âŒ æ¢å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                const success = DataManager.clearAll();
                
                if (success) {
                    UIManager.showStatus('import-status', 'âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
                    UIManager.updateStats();
                } else {
                    UIManager.showStatus('import-status', 'âŒ æ¸…ç©ºæ•°æ®å¤±è´¥', 'error');
                }
            } catch (error) {
                UIManager.showStatus('import-status', `âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
        function setupDragAndDrop() {
            const dropZone = document.querySelector('.file-input-label');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.style.borderColor = 'var(--primary)';
                    dropZone.style.backgroundColor = 'rgba(76, 201, 240, 0.1)';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.style.borderColor = '#ccc';
                    dropZone.style.backgroundColor = 'white';
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        const event = { target: { files: [file] } };
                        importData(event);
                    } else {
                        UIManager.showStatus('import-status', 'âŒ è¯·é€‰æ‹©JSONæ–‡ä»¶', 'error');
                    }
                }
            }, false);
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°ç»Ÿè®¡
        document.addEventListener('DOMContentLoaded', () => {
            UIManager.updateStats();
            setupDragAndDrop();
        });
    </script>
</body>
</html>
