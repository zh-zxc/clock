# WebDAV云盘同步详细指南

## 🎯 目标
为时钟应用添加WebDAV云盘同步功能，支持Infini Cloud (`https://rebun.infini-cloud.net/dav/`)。

## ⚠️ 重要提示
**浏览器网页直接连接WebDAV会遇到CORS跨域限制**，这是浏览器的安全机制。以下是几种解决方案：

---

## 方案1：使用浏览器扩展（最简单）⭐推荐

### 安装CORS扩展
1. **Chrome浏览器**：
   - 打开Chrome网上应用店
   - 搜索 "CORS Unblock" 或 "Allow CORS"
   - 安装扩展

2. **Firefox浏览器**：
   - 打开Firefox附加组件商店
   - 搜索 "CORS Everywhere" 或 "Allow CORS"
   - 安装扩展

3. **Edge浏览器**：
   - 打开Edge附加组件商店
   - 搜索 "CORS Unblock"
   - 安装扩展

### 使用步骤
1. 安装扩展后，点击浏览器工具栏的扩展图标
2. 启用CORS绕过功能
3. 打开时钟应用（http://localhost:3000）
4. 配置WebDAV连接：
   - 服务器地址：`https://rebun.infini-cloud.net/dav/`
   - 用户名：您的Infini Cloud用户名/邮箱
   - 密码：您的Infini Cloud**应用密码**（不是登录密码）
   - 同步路径：`/clock-data/`（可选）
5. 点击"连接 WebDAV"按钮

### 获取Infini Cloud应用密码
1. 登录Infini Cloud网页版
2. 进入账户设置
3. 找到"应用密码"或"安全设置"
4. 生成新的应用密码
5. 使用该密码连接WebDAV

---

## 方案2：使用本地代理服务器

### 启动代理服务器
1. 打开终端/命令行
2. 进入时钟目录：
   ```bash
   cd 时钟
   ```

3. 启动代理服务器：
   ```bash
   node proxy-server.js
   ```

4. 代理服务器启动成功后，会显示：
   ```
   本地代理服务器启动成功!
   代理地址: http://localhost:8080
   使用方法: 在WebDAV配置中使用代理地址
   示例: http://localhost:8080?url=https://rebun.infini-cloud.net/dav/
   ```

### 配置WebDAV使用代理
1. 打开时钟应用（http://localhost:3000）
2. 在WebDAV配置中：
   - **WebDAV服务器地址**：`http://localhost:8080?url=https://rebun.infini-cloud.net/dav/`
   - **用户名**：您的Infini Cloud用户名/邮箱
   - **密码**：您的Infini Cloud应用密码
   - **同步路径**：`/clock-data/`（可选）
   - **取消勾选**"使用直接连接"选项
3. 点击"连接 WebDAV"按钮

### 代理服务器工作原理
- 本地代理服务器运行在您的电脑上
- 它接收来自浏览器的请求
- 转发请求到Infini Cloud服务器
- 绕过浏览器的CORS限制
- 数据完全在本地传输，安全可靠

---

## 方案3：使用在线CORS代理

### 使用公共代理服务
1. 打开时钟应用（http://localhost:3000）
2. 在WebDAV配置中：
   - **WebDAV服务器地址**：使用以下之一：
     - `https://cors-anywhere.herokuapp.com/https://rebun.infini-cloud.net/dav/`
     - `https://api.allorigins.win/raw?url=https://rebun.infini-cloud.net/dav/`
   - **用户名**：您的Infini Cloud用户名/邮箱
   - **密码**：您的Infini Cloud应用密码
   - **同步路径**：`/clock-data/`（可选）
   - **取消勾选**"使用直接连接"选项
3. 点击"连接 WebDAV"按钮

### 注意事项
- 公共代理服务可能不稳定
- 可能有请求限制
- 不适合处理大量数据
- 建议仅用于测试

---

## 方案4：使用浏览器开发者模式（高级）

### 修改浏览器启动参数
1. 关闭所有Chrome窗口
2. 右键点击Chrome快捷方式
3. 选择"属性"
4. 在"目标"字段末尾添加：
   ```
   --disable-web-security --user-data-dir="C:/temp/chrome-data"
   ```
5. 启动Chrome（会显示安全警告）

### 注意事项
- 此方法会禁用浏览器安全功能
- 仅用于开发和测试
- 不要在禁用安全模式下访问敏感网站
- 测试完成后请使用正常浏览器

---

## 🔧 连接故障排除

### 问题1：连接失败 - "NetworkError when attempting to fetch resource"

**解决方案**：
1. 检查网络连接是否正常
2. 确认Infini Cloud服务是否正常运行
3. 尝试使用浏览器扩展方案
4. 查看同步日志获取详细错误信息

### 问题2：认证失败 - "401 Unauthorized"

**解决方案**：
1. 确认使用的是**应用密码**，不是登录密码
2. 检查用户名是否正确（邮箱格式）
3. 重新生成应用密码
4. 检查Infini Cloud账户状态

### 问题3：文件不存在 - "404 Not Found"

**解决方案**：
1. 首次使用时会自动创建文件
2. 检查同步路径是否正确
3. 确认WebDAV服务器地址正确

### 问题4：CORS错误 - "Access to fetch blocked by CORS policy"

**解决方案**：
1. 使用浏览器扩展（方案1）
2. 使用本地代理服务器（方案2）
3. 使用在线CORS代理（方案3）

---

## 📊 方案对比

| 方案 | 难度 | 稳定性 | 安全性 | 推荐度 |
|------|------|--------|--------|--------|
| 浏览器扩展 | ⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 本地代理 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 在线代理 | ⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ |
| 禁用安全 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ | ⭐ |

---

## 🔒 数据安全说明

### 加密机制
- 使用AES-256-GCM算法加密数据
- 支持自定义加密密钥
- 即使云盘被入侵，数据也无法被读取
- 加密后的数据以Base64编码存储

### 密钥管理
- 默认密钥：`ClockAppDefaultKey2024!`
- 建议使用自定义密钥
- 请妥善保管密钥，丢失后无法恢复数据
- 密钥不会上传到云端

---

## 📝 使用建议

### 日常使用
1. **推荐使用浏览器扩展方案**（最简单）
2. 定期备份数据到本地文件（使用local-backup.html）
3. 重要数据建议多处备份

### 数据同步策略
1. **首次使用**：上传本地数据到云端
2. **日常使用**：使用"快速同步"按钮
3. **数据冲突**：手动选择上传、下载或合并
4. **定期备份**：使用本地备份工具导出JSON文件

### 故障处理
1. 连接失败时，查看同步日志
2. 尝试不同的连接方案
3. 使用本地备份工具作为备用方案
4. 在GitHub或社区寻求帮助

---

## 🎯 推荐配置

### Infini Cloud最佳实践
```
服务器地址: https://rebun.infini-cloud.net/dav/
用户名: your-email@example.com
密码: [应用密码]
同步路径: /clock-data/
加密: 启用
密钥: [自定义密钥]
直接连接: 取消勾选（使用代理）
```

### 备用方案
如果WebDAV始终无法连接，使用：
1. **本地备份工具**（local-backup.html）
2. 定期导出数据到JSON文件
3. 将备份文件保存到百度网盘/阿里云盘等

---

## 📞 获取帮助

如果遇到问题：
1. 查看同步日志获取详细错误信息
2. 检查浏览器控制台错误
3. 参考本指南的故障排除部分
4. 尝试不同的连接方案

---

## ✅ 成功标志

连接成功后，您将看到：
- 连接状态显示"已连接"（绿色）
- 同步按钮变为可用状态
- 同步日志显示"WebDAV连接成功"
- 可以正常使用上传、下载、同步功能

---

**最后更新**：2026年1月20日  
**版本**：1.0.0
